<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Dashboard</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<style>
body { margin:0; font-family:'Poppins'; background:#f9fafb; }
.navbar { background:#0f8b6d; padding:20px 40px; color:white; display:flex; justify-content:space-between; }
.nav-links { list-style:none; display:flex; }
.nav-links li { margin-left:25px; }
.nav-links a { color:white; text-decoration:none; }

h1 { margin:40px 40px 5px; font-size:36px; }
.sub { margin-left:40px; color:#555; }

.stats-box { display:flex; gap:25px; margin:30px 40px; }
.card { flex:1; padding:25px; border-radius:16px; color:white; height:150px; }
.green { background:#02b88f; }
.blue { background:#4c7bf3; }
.orange { background:#f78b2d; }
.value { font-size:40px; font-weight:700; margin-top:10px; }

.history { margin:40px; background:white; border-radius:16px; padding:20px; }

table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { border:1px solid #ddd; padding:10px; text-align:left; }
th { background:#f2f2f2; }

.filters { margin:20px 40px; display:flex; gap:15px; }
select, input, button {
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
}
button {
  background:#0f8b6d;
  color:white;
  border:none;
  cursor:pointer;
}
</style>
</head>

<body>

<nav class="navbar">
  <div>♻️ EcoPick</div>
  <ul class="nav-links">
    <li><a href="index.html">Home</a></li>
    <li><a href="detect.html">Detect</a></li>
    <li><a href="dashboard.html">Dashboard</a></li>
    <li><a href="admin.html">Admin</a></li>
    <li><a href="profile.html">Profile</a></li>
  </ul>
</nav>

<h1>Your Dashboard</h1>
<p class="sub">Track your recycling history</p>

<div class="stats-box">
  <div class="card green">
    <h3>Total Detections</h3>
    <div class="value" id="totalDetections">0</div>
  </div>
  <div class="card blue">
    <h3>Total Weight (kg)</h3>
    <div class="value" id="totalWeight">0.00</div>
  </div>
</div>

<div class="stats-box" id="material-breakdown-summary">
    <!-- Content will be generated by script -->
</div>

<div class="stats-box">
  <div class="card orange">
    <h3>Total Value</h3>
    <div class="value" id="totalValue">₹0.00</div>
  </div>
</div>

<div class="filters">
  <select id="materialFilter"></select>
  <input type="date" id="dateFilter">
  <select id="priceSort">
    <option value="">Sort by Price</option>
    <option value="high">High to Low</option>
    <option value="low">Low to High</option>
  </select>
  <button onclick="downloadReceipt()">Download Receipt</button>
</div>

<div class="history">
  <table id="historyTable"></table>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {

    // ================= GLOBAL DATA STORE =================
    let userProfile = null;
    let transactions = [];

    // ================= DOM ELEMENTS =================
    const materialFilter = document.getElementById("materialFilter");
    const dateFilter = document.getElementById("dateFilter");
    const priceSort = document.getElementById("priceSort");

    // ================= DATA FETCHING =================
    async function fetchDashboardData() {
        try {
            const response = await fetch('/api/dashboard');
            
            if (!response.ok) {
                // If not authenticated or another error occurs, redirect to login
                window.location.href = 'index.html?auth=required';
                return;
            }
            
            const data = await response.json();

            if (data.status === 'success' && data.user) {
                userProfile = data.user;
                transactions = data.user.transactions || [];
                initializeApp();
            } else {
                // Handle cases where the server returns a success status but no user
                window.location.href = 'index.html?auth=failed';
            }
        } catch (error) {
            console.error('Error fetching dashboard data:', error);
            // Show an error message to the user on the dashboard itself
            document.body.innerHTML = '<h1>Error</h1><p>Could not load dashboard data. Please try again later.</p>';
        }
    }

    // ================= INITIALIZE APP =================
    function initializeApp() {
        if (!userProfile) return;

        // Welcome message & stats
        document.querySelector('h1').textContent = `Welcome, ${userProfile.name}!`; // Name is now in the user object
        document.querySelector('.sub').textContent = `Here is your recycling history and environmental impact.`;
        document.getElementById("totalDetections").textContent = userProfile.stats.detections || 0;
        document.getElementById("totalWeight").textContent = (userProfile.stats.totalWeight || 0).toFixed(2);
        document.getElementById("totalValue").textContent = "₹" + (userProfile.stats.totalEarnings || 0).toFixed(2);

        // Render material breakdown
        const materialSummary = {};
        transactions.forEach(t => {
            if (materialSummary[t.material]) {
                materialSummary[t.material] += t.weight;
            } else {
                materialSummary[t.material] = t.weight;
            }
        });

        const breakdownContainer = document.getElementById("material-breakdown-summary");
        let breakdownHtml = '<h3>Material Breakdown (by Weight)</h3>';
        if (Object.keys(materialSummary).length > 0) {
            for (const material in materialSummary) {
                breakdownHtml += `
                    <div class="card blue">
                        <h4>${material}</h4>
                        <div class="value">${materialSummary[material].toFixed(2)} kg</div>
                    </div>
                `;
            }
        } else {
            breakdownHtml += '<p>No materials recorded yet.</p>';
        }
        breakdownContainer.innerHTML = breakdownHtml;

        // Populate filters and render table
        populateMaterialFilter();
        render(transactions);

        // Add event listeners
        materialFilter.addEventListener("change", applyFilters);
        dateFilter.addEventListener("change", applyFilters);
        priceSort.addEventListener("change", applyFilters);
        document.querySelector('button[onclick="downloadReceipt()"]').addEventListener('click', downloadReceipt);
    }

    // ================= MATERIAL DROPDOWN =================
    function populateMaterialFilter() {
        materialFilter.innerHTML = `<option value="">All Materials</option>`;
        const materials = [...new Set(transactions.map(t => t.material))];
        materials.forEach(m => {
            const opt = document.createElement("option");
            opt.value = m;
            opt.textContent = m;
            materialFilter.appendChild(opt);
        });
    }

    // ================= RENDER TABLE =================
    function render(items) {
        const table = document.getElementById("historyTable");
        if (!items || items.length === 0) {
            table.innerHTML = "<tr><td colspan='5' style='text-align:center;'>You have no recycling history yet.</td></tr>";
            return;
        }

        let html = `
            <tr>
                <th>Material</th>
                <th>Weight (kg)</th>
                <th>Earnings</th>
                <th>Date</th>
            </tr>
        `;

        items.forEach(t => {
            html += `
            <tr>
                <td>${t.material}</td>
                <td>${t.weight.toFixed(2)}</td>
                <td>₹${t.earnings.toFixed(2)}</td>
                <td>${new Date(t.timestamp).toLocaleDateString()}</td>
            </tr>
            `;
        });

        table.innerHTML = html;
    }

    // ================= FILTER & SORT =================
    function applyFilters() {
        let filtered = [...transactions];

        if (materialFilter.value) {
            filtered = filtered.filter(t => t.material === materialFilter.value);
        }

        if (dateFilter.value) {
            const selectedDate = new Date(dateFilter.value).toLocaleDateString();
            filtered = filtered.filter(t => new Date(t.timestamp).toLocaleDateString() === selectedDate);
        }

        if (priceSort.value === "high") {
            filtered.sort((a, b) => b.earnings - a.earnings);
        } else if (priceSort.value === "low") {
            filtered.sort((a, b) => a.earnings - b.earnings);
        }

        render(filtered);
    }
    
    // ================= DOWNLOAD RECEIPT =================
   
    window.downloadReceipt = function() {
        if (!userProfile) {
            alert("User data is not loaded.");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.width;
        const brandColor = "#0f8b6d";

        doc.setFont("helvetica", "bold");
        doc.setFontSize(26);
        doc.setTextColor(brandColor);
        doc.text("ECOPICK", pageWidth / 2, 20, { align: "center" });
        doc.setFont("helvetica", "italic");
        doc.setFontSize(10);
        doc.setTextColor(brandColor);
        doc.text("Smart Recycling. Real Impact.", pageWidth / 2, 28, { align: "center" });

        const now = new Date();
        const receiptId = `RCPT-${Date.now().toString().slice(-6)}`;
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.setTextColor("#000000");
        doc.text(`Receipt ID: ${receiptId}`, 14, 40);
        doc.text(`Date: ${now.toLocaleDateString()}`, 14, 45);
        doc.text(`Time: ${now.toLocaleTimeString()}`, 14, 50);
        doc.text(`Customer ID: ${userProfile.profileId}`, 14, 55);
        doc.text(`Customer Name: ${userProfile.name}`, 14, 60);
        doc.text(`Phone: ${userProfile.phoneNumber}`, 14, 65);

        doc.setFont("helvetica", "italic");
        doc.setFontSize(10);
        doc.setTextColor("#666666");
        doc.text("“Your small action today creates a cleaner tomorrow.”", pageWidth / 2, 77, { align: "center" });
        
        doc.setDrawColor("#cccccc");
        doc.line(14, 83, pageWidth - 14, 83);

        const body = [];
        const materialSummary = {};
        
        // Use the currently filtered items on the screen for the receipt
        let filtered = [...transactions];
        if (materialFilter.value) filtered = filtered.filter(t => t.material === materialFilter.value);
        if (dateFilter.value) {
            const selectedDate = new Date(dateFilter.value).toLocaleDateString();
            filtered = filtered.filter(t => new Date(t.timestamp).toLocaleDateString() === selectedDate);
        }

        filtered.forEach(t => {
            if (materialSummary[t.material]) {
                materialSummary[t.material] += t.weight;
            } else {
                materialSummary[t.material] = t.weight;
            }
            body.push([
                t.material,
                t.weight.toFixed(2) + " kg",
                "Rs " + (t.earnings / t.weight).toFixed(2), // Calculate price/kg
                "Rs " + t.earnings.toFixed(2)
            ]);
        });

        doc.autoTable({
            head: [["Material", "Weight", "Price/kg", "Total Price"]],
            body,
            startY: 88,
            theme: 'grid'
        });
        
        let y = doc.lastAutoTable.finalY + 10;
        
        const totalW = userProfile.stats.totalWeight;
        const totalV = userProfile.stats.totalEarnings;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("Lifetime Summary", 14, y);
        y += 8;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        
        let summaryText = "";
        // You can create a summary of all-time materials if needed, here we just show lifetime totals
        summaryText = `Total items recycled: ${userProfile.stats.detections}`;
        doc.text(summaryText, 14, y);
        y += 5;
        doc.text(`Environmental Impact: Saved approx. ${(totalW * 1.5).toFixed(2)}kg of CO2 emissions.`, 14, y);
        y += 10;

        doc.setDrawColor("#cccccc");
        doc.line(14, y, pageWidth - 14, y);
        y += 8;
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        doc.text(`Lifetime Weight: ${totalW.toFixed(2)} kg`, 14, y);
        doc.text(`Lifetime Earnings: Rs ${totalV.toFixed(2)}`, pageWidth - 14, y, { align: "right" });
        y += 15;

        const tips = [
            "Try using a reusable water bottle instead of buying single-use plastic ones.",
            "Turn off lights when you leave a room to save energy.",
            "Composting food scraps can reduce landfill waste significantly.",
            "Opt for digital receipts and statements to save paper."
        ];
        const tip = tips[Math.floor(Math.random() * tips.length)];
        doc.setFont("helvetica", "italic");
        doc.setFontSize(9);
        doc.setTextColor("#444444");
        doc.text(`Eco Tip of the Day: ${tip}`, pageWidth / 2, y, { align: "center" });
        y += 15;

        doc.setFont("helvetica", "bold");
        doc.setTextColor(brandColor);
        doc.text("by ECOPICK", pageWidth / 2, y, { align: "center" });

        doc.save(`EcoPick_Receipt_${userProfile.profileId}.pdf`);
    }

    // ================= KICKSTART THE APP =================
    fetchDashboardData();


    window.addEventListener('focus', fetchDashboardData);
});
</script>
</body>
</html>
